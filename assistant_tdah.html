<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant TDAH Intelligent</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Mode sombre (par defaut) */
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --bg-tertiary: rgba(255, 255, 255, 0.05);
            --text-primary: #fff;
            --text-secondary: #a0a0a0;
            --text-muted: #888;
            --text-conseil: #ccc;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            /* Mode clair */
            --bg-primary: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            --bg-secondary: rgba(0, 0, 0, 0.05);
            --bg-tertiary: rgba(0, 0, 0, 0.03);
            --text-primary: #1a1a2e;
            --text-secondary: #555;
            --text-muted: #777;
            --text-conseil: #444;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --border-color: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: var(--text-secondary);
        }

        /* Bouton de theme */
        .theme-toggle, .lang-toggle {
            position: fixed;
            top: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 1000;
        }

        .theme-toggle {
            right: 20px;
        }

        .lang-toggle {
            right: 80px;
            font-size: 16px;
            font-weight: bold;
        }

        .theme-toggle:hover, .lang-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .input-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 16px;
            resize: vertical;
            min-height: 100px;
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        .spiciness-section {
            margin: 20px 0;
        }

        .spiciness-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .spiciness-slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #4CAF50, #FF9800, #f44336);
            border-radius: 5px;
            outline: none;
        }

        .spiciness-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .spiciness-display {
            text-align: center;
            margin-top: 10px;
            font-size: 1.2em;
        }

        .btn {
            width: 100%;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .task-item:hover {
            background: var(--bg-secondary);
        }

        .task-item.completed {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .task-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #4CAF50;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-category {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 15px 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        /* Pomodoro Timer Styles */
        .pomodoro-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
        }

        .pomodoro-section h2 {
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .timer-status {
            font-size: 1.2em;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .timer-status.work {
            color: #4CAF50;
        }

        .timer-status.break {
            color: #FF9800;
        }

        .timer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-timer {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-start {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: #fff;
        }

        .btn-pause {
            background: linear-gradient(135deg, #FF9800 0%, #f57c00 100%);
            color: #fff;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: #fff;
        }

        .btn-timer:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .pomodoro-settings {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .setting-item label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .setting-item input {
            width: 60px;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--text-primary);
            text-align: center;
            font-size: 16px;
        }

        .pomodoro-count {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .pomodoro-count span {
            color: var(--accent-primary);
            font-weight: bold;
        }

        /* Conseils Section Styles */
        .conseils-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .conseils-section h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .conseil-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s;
        }

        .conseil-card:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .conseil-card h3 {
            color: var(--accent-primary);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .conseil-card p {
            color: var(--text-conseil);
            line-height: 1.6;
        }

        .btn-new-conseil {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-new-conseil:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .conseils-categories {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }

        .category-btn {
            padding: 8px 16px;
            border: 2px solid var(--accent-primary);
            background: transparent;
            color: var(--accent-primary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .category-btn.active,
        .category-btn:hover {
            background: var(--accent-primary);
            color: #fff;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 25px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: #fff;
        }

        .nav-tab:hover:not(.active) {
            background: var(--input-bg);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section A Connaitre */
        .connaitre-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .connaitre-section h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .matiere-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }

        .matiere-btn {
            padding: 10px 18px;
            border: 2px solid var(--accent-primary);
            background: transparent;
            color: var(--accent-primary);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .matiere-btn.active,
        .matiere-btn:hover {
            background: var(--accent-primary);
            color: #fff;
        }

        .matiere-btn .matiere-icon {
            margin-right: 5px;
        }

        .matiere-content {
            display: none;
        }

        .matiere-content.active {
            display: block;
        }

        /* Frise chronologique */
        .frise-container {
            margin: 20px 0;
        }

        .frise-title {
            font-size: 1.2em;
            color: var(--accent-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-primary);
        }

        .frise {
            position: relative;
            padding-left: 30px;
        }

        .frise::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
        }

        .frise-item {
            position: relative;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .frise-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--accent-primary);
            border-radius: 50%;
            border: 3px solid var(--bg-secondary);
        }

        .frise-item:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .frise-date {
            font-weight: bold;
            color: var(--accent-primary);
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .frise-event {
            color: var(--text-primary);
            font-weight: 500;
        }

        .frise-detail {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Cartes de definitions */
        .definitions-container {
            margin: 20px 0;
        }

        .definition-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-left: 4px solid #4CAF50;
            transition: all 0.3s;
        }

        .definition-card:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .definition-term {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1.05em;
            margin-bottom: 8px;
        }

        .definition-text {
            color: var(--text-conseil);
            line-height: 1.5;
        }

        /* Cartes de formules */
        .formules-container {
            margin: 20px 0;
        }

        .formule-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-left: 4px solid #FF9800;
            transition: all 0.3s;
        }

        .formule-card:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .formule-name {
            font-weight: bold;
            color: #FF9800;
            font-size: 1.05em;
            margin-bottom: 8px;
        }

        .formule-expression {
            font-family: 'Courier New', monospace;
            background: var(--input-bg);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 1.1em;
            color: var(--text-primary);
            margin: 10px 0;
            text-align: center;
        }

        .formule-description {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Type badges */
        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .type-badge.frise {
            background: rgba(102, 126, 234, 0.2);
            color: var(--accent-primary);
        }

        .type-badge.definition {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .type-badge.formule {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
        }

        /* Section vide */
        .empty-section {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-section-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Bouton ajouter contenu IA */
        .btn-generate-content {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-generate-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-generate-content:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Style pour le select niveau */
        .niveau-select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--accent-primary);
            border-radius: 10px;
            background-color: #1a1a2e;
            color: var(--text-primary);
            font-size: 16px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23667eea' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

        [data-theme="light"] .niveau-select {
            background-color: #ffffff;
        }

        .niveau-select option {
            background-color: #1a1a2e;
            color: #ffffff;
            padding: 10px;
        }

        [data-theme="light"] .niveau-select option {
            background-color: #ffffff;
            color: #1a1a2e;
        }

        /* Styles pour le feedback */
        .feedback-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            border: 2px dashed var(--accent-primary);
        }

        .feedback-section h3 {
            margin-bottom: 20px;
        }

        .feedback-rating {
            margin-bottom: 20px;
        }

        .feedback-rating span {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .rating-stars {
            display: flex;
            gap: 8px;
        }

        .star-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
            padding: 5px;
        }

        .star-btn:hover,
        .star-btn.active {
            color: #FFD700;
            transform: scale(1.2);
        }

        .star-btn.active {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .feedback-options {
            margin-bottom: 20px;
        }

        .feedback-options span {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .feedback-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .feedback-tag {
            padding: 8px 14px;
            border: 2px solid var(--border-color);
            background: transparent;
            color: var(--text-primary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .feedback-tag:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .feedback-tag.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .feedback-comment {
            margin-bottom: 15px;
        }

        .feedback-comment label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .feedback-comment textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .feedback-success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            color: #4CAF50;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .feedback-stats {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .feedback-stats strong {
            color: var(--accent-primary);
        }

        /* Felicitations */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .celebration-content {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            animation: bounceIn 0.5s ease;
            max-width: 90%;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .celebration-emoji {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 0.6s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-15px); }
        }

        .celebration-title {
            font-size: 2em;
            color: #fff;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .celebration-message {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 25px;
        }

        .celebration-close {
            background: #fff;
            color: var(--accent-primary);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .celebration-close:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 1001;
            animation: fall linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
            }
        }
    </style>
</head>
<body>
    <!-- Bouton de basculement langue -->
    <button class="lang-toggle" id="lang-toggle" title="Switch to English">
        <span id="lang-icon">EN</span>
    </button>

    <!-- Bouton de basculement theme -->
    <button class="theme-toggle" id="theme-toggle" title="Changer de theme">
        <span id="theme-icon">&#9790;</span>
    </button>

    <div class="container">
        <header>
            <h1>Assistant TDAH Intelligent</h1>
            <p>Decompose tes taches, gere ton temps et decouvre des conseils adaptes</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="taches">Taches</button>
            <button class="nav-tab" data-tab="pomodoro">Pomodoro</button>
            <button class="nav-tab" data-tab="conseils">Conseils</button>
            <button class="nav-tab" data-tab="connaitre">A connaitre</button>
        </div>

        <!-- Onglet Taches -->
        <div class="tab-content active" id="tab-taches">
        <div class="input-section">
            <label for="task-input">Decris ta tache :</label>
            <textarea id="task-input" placeholder="Ex: Faire ma dissertation de francais sur le romantisme pour lundi..."></textarea>

            <div class="spiciness-section">
                <div class="spiciness-label">
                    <span>Niveau de detail</span>
                    <span id="spiciness-value">3</span>
                </div>
                <input type="range" min="1" max="5" value="3" class="spiciness-slider" id="spiciness-slider">
                <div class="spiciness-display" id="spiciness-display">Equilibre</div>
            </div>

            <button class="btn btn-primary" id="decompose-btn">Decomposer ma tache</button>
        </div>

        <div class="results-section" id="results-section">
            <div class="loading" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Connexion a l'IA...</p>
                <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">Cela peut prendre jusqu'a 45 secondes</p>
            </div>

            <div id="results-content">
                <div class="results-header">
                    <h2>Ton plan de travail</h2>
                    <span id="task-count"></span>
                </div>

                <ul class="task-list" id="task-list"></ul>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-tasks">0</div>
                        <div class="stat-label">Etapes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completed-tasks">0</div>
                        <div class="stat-label">Terminees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="progress">0%</div>
                        <div class="stat-label">Progression</div>
                    </div>
                </div>
            </div>

            <div class="error" id="error-message" style="display: none;"></div>
        </div>
        </div>

        <!-- Onglet Pomodoro -->
        <div class="tab-content" id="tab-pomodoro">
            <div class="pomodoro-section">
                <h2>Minuteur Pomodoro</h2>
                <div class="timer-status" id="timer-status">Pret a travailler</div>
                <div class="timer-display" id="timer-display">25:00</div>

                <div class="timer-buttons">
                    <button class="btn-timer btn-start" id="btn-start">Demarrer</button>
                    <button class="btn-timer btn-pause" id="btn-pause" style="display: none;">Pause</button>
                    <button class="btn-timer btn-reset" id="btn-reset">Reinitialiser</button>
                </div>

                <div class="pomodoro-settings">
                    <div class="setting-item">
                        <label>Travail (min)</label>
                        <input type="number" id="work-duration" value="25" min="1" max="60">
                    </div>
                    <div class="setting-item">
                        <label>Pause courte (min)</label>
                        <input type="number" id="short-break" value="5" min="1" max="30">
                    </div>
                    <div class="setting-item">
                        <label>Pause longue (min)</label>
                        <input type="number" id="long-break" value="15" min="1" max="60">
                    </div>
                </div>

                <div class="pomodoro-count">
                    Pomodoros completes : <span id="pomodoro-count">0</span>
                </div>
            </div>
        </div>

        <!-- Onglet Conseils -->
        <div class="tab-content" id="tab-conseils">
            <div class="conseils-section">
                <h2>Conseils TDAH</h2>

                <div class="conseils-categories">
                    <button class="category-btn active" data-category="tous">Tous</button>
                    <button class="category-btn" data-category="concentration">Concentration</button>
                    <button class="category-btn" data-category="organisation">Organisation</button>
                    <button class="category-btn" data-category="motivation">Motivation</button>
                    <button class="category-btn" data-category="gestion-stress">Gestion du stress</button>
                </div>

                <div id="conseils-container">
                    <div class="conseil-card" data-category="concentration">
                        <h3>La regle des 2 minutes</h3>
                        <p>Si une tache prend moins de 2 minutes, fais-la immediatement. Cela evite l'accumulation de petites taches qui encombrent ton esprit.</p>
                    </div>
                    <div class="conseil-card" data-category="organisation">
                        <h3>Un seul endroit pour tout noter</h3>
                        <p>Utilise un seul carnet ou une seule application pour toutes tes notes. Evite d'eparpiller tes idees sur plusieurs supports.</p>
                    </div>
                    <div class="conseil-card" data-category="concentration">
                        <h3>Elimine les distractions</h3>
                        <p>Mets ton telephone en mode avion, ferme les onglets inutiles, et previens ton entourage que tu travailles. Chaque interruption te coute 20 minutes de reconcentration.</p>
                    </div>
                    <div class="conseil-card" data-category="motivation">
                        <h3>Recompense-toi</h3>
                        <p>Apres chaque tache accomplie, accorde-toi une petite recompense : une pause, un snack, ou quelques minutes sur ton activite preferee.</p>
                    </div>
                    <div class="conseil-card" data-category="gestion-stress">
                        <h3>La respiration 4-7-8</h3>
                        <p>Inspire pendant 4 secondes, retiens ta respiration 7 secondes, expire pendant 8 secondes. Repete 3 fois pour calmer rapidement ton anxiete.</p>
                    </div>
                    <div class="conseil-card" data-category="organisation">
                        <h3>Prepare la veille</h3>
                        <p>Chaque soir, prepare tes affaires et note les 3 taches prioritaires du lendemain. Tu gagneras du temps et de l'energie mentale le matin.</p>
                    </div>
                    <div class="conseil-card" data-category="motivation">
                        <h3>Commence par le plus difficile</h3>
                        <p>Tackle ta tache la plus redoutee en premier, quand ton energie est au maximum. Le reste de la journee te semblera plus facile.</p>
                    </div>
                    <div class="conseil-card" data-category="concentration">
                        <h3>Le body doubling</h3>
                        <p>Travaille en presence d'une autre personne (meme en visio). La presence d'autrui aide a maintenir la concentration et la motivation.</p>
                    </div>
                    <div class="conseil-card" data-category="gestion-stress">
                        <h3>Accepte l'imperfection</h3>
                        <p>Mieux vaut une tache terminee a 80% qu'une tache parfaite jamais finie. Le perfectionnisme est souvent l'ennemi de la productivite.</p>
                    </div>
                    <div class="conseil-card" data-category="organisation">
                        <h3>Utilise des alarmes</h3>
                        <p>Programme des rappels pour les taches importantes, les rendez-vous, et meme les pauses. Ton cerveau TDAH a besoin de signaux externes.</p>
                    </div>
                </div>

                <button class="btn-new-conseil" id="btn-new-conseil">Obtenir un conseil personnalise (IA)</button>
                <div id="conseil-ia" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Onglet A Connaitre -->
        <div class="tab-content" id="tab-connaitre">
            <div class="connaitre-section">
                <h2>Fiches de revision personnalisees</h2>

                <div class="input-section" style="margin-bottom: 20px;">
                    <label for="revision-input">Quel sujet veux-tu reviser ?</label>
                    <textarea id="revision-input" placeholder="Ex: La Revolution francaise, Les equations du second degre, Le romantisme en litterature, Les protocoles reseau TCP/IP..."></textarea>

                    <div style="margin-top: 15px;">
                        <label for="niveau-select" style="display: block; margin-bottom: 8px;">Ton niveau scolaire :</label>
                        <select id="niveau-select" class="niveau-select">
                            <option value="college">College (6e - 3e)</option>
                            <option value="seconde">Seconde</option>
                            <option value="premiere">Premiere</option>
                            <option value="terminale">Terminale</option>
                            <option value="bts" selected>BTS / DUT</option>
                            <option value="licence">Licence / Prepa</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" id="btn-generate-fiche" style="margin-top: 15px;">Generer ma fiche de revision</button>
                </div>

                <div id="fiche-loading" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Connexion a l'IA...</p>
                    <p style="font-size: 0.85em; color: var(--text-secondary); margin-top: 10px;">Cela peut prendre jusqu'a 45 secondes</p>
                </div>

                <div id="fiche-content" style="display: none;">
                    <!-- Dates/Frise (si pertinent) -->
                    <div id="fiche-dates" class="frise-container" style="display: none;">
                        <h3 class="frise-title">&#128197; Dates importantes</h3>
                        <div class="frise" id="frise-list"></div>
                    </div>

                    <!-- Definitions -->
                    <div id="fiche-definitions" class="definitions-container" style="display: none;">
                        <h3 class="frise-title">&#128213; Definitions cles</h3>
                        <div id="definitions-list"></div>
                    </div>

                    <!-- Formules -->
                    <div id="fiche-formules" class="formules-container" style="display: none;">
                        <h3 class="frise-title">&#128290; Formules essentielles</h3>
                        <div id="formules-list"></div>
                    </div>

                    <!-- Points cles / A retenir -->
                    <div id="fiche-points" class="definitions-container" style="display: none;">
                        <h3 class="frise-title">&#128161; Points cles a retenir</h3>
                        <div id="points-list"></div>
                    </div>

                    <!-- Section Feedback -->
                    <div id="fiche-feedback" class="feedback-section">
                        <h3 class="frise-title">&#128172; Ton avis sur cette fiche</h3>

                        <div class="feedback-rating">
                            <span>Cette fiche t'a ete utile ?</span>
                            <div class="rating-stars" id="rating-stars">
                                <button class="star-btn" data-rating="1">&#9734;</button>
                                <button class="star-btn" data-rating="2">&#9734;</button>
                                <button class="star-btn" data-rating="3">&#9734;</button>
                                <button class="star-btn" data-rating="4">&#9734;</button>
                                <button class="star-btn" data-rating="5">&#9734;</button>
                            </div>
                        </div>

                        <div class="feedback-options">
                            <span>Qu'est-ce qui pourrait etre ameliore ?</span>
                            <div class="feedback-tags" id="feedback-tags">
                                <button class="feedback-tag" data-tag="trop-simple">Trop simple</button>
                                <button class="feedback-tag" data-tag="trop-complexe">Trop complexe</button>
                                <button class="feedback-tag" data-tag="manque-exemples">Manque d'exemples</button>
                                <button class="feedback-tag" data-tag="manque-details">Manque de details</button>
                                <button class="feedback-tag" data-tag="trop-long">Trop long</button>
                                <button class="feedback-tag" data-tag="trop-court">Trop court</button>
                                <button class="feedback-tag" data-tag="formules-incorrectes">Formules incorrectes</button>
                                <button class="feedback-tag" data-tag="parfait">Parfait !</button>
                            </div>
                        </div>

                        <div class="feedback-comment">
                            <label for="feedback-text">Commentaire (optionnel) :</label>
                            <textarea id="feedback-text" placeholder="Dis-nous ce qui manque ou ce qui pourrait etre mieux..."></textarea>
                        </div>

                        <button class="btn btn-primary" id="btn-submit-feedback" style="margin-top: 10px;">Envoyer mon avis</button>
                        <div id="feedback-success" class="feedback-success" style="display: none;">
                            Merci pour ton retour ! On en tiendra compte pour les prochaines fiches.
                        </div>
                    </div>
                </div>

                <div id="fiche-error" class="error" style="display: none;"></div>

                <!-- Historique des fiches generees -->
                <div id="fiches-historique" style="margin-top: 30px; display: none;">
                    <h3 style="color: var(--text-secondary); margin-bottom: 15px;">Fiches precedentes</h3>
                    <div id="historique-list" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // GESTION DU THEME CLAIR/SOMBRE
        // =============================================
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        // Charger le theme sauvegarde ou detecter la preference systeme
        function loadTheme() {
            const savedTheme = localStorage.getItem('tdah-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            } else {
                // Detecter la preference systeme
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = prefersDark ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                updateThemeIcon(theme);
            }
        }

        function updateThemeIcon(theme) {
            if (theme === 'light') {
                themeIcon.innerHTML = '&#9728;'; // Soleil
                themeToggle.title = 'Passer en mode sombre';
            } else {
                themeIcon.innerHTML = '&#9790;'; // Lune
                themeToggle.title = 'Passer en mode clair';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('tdah-theme', newTheme);
            updateThemeIcon(newTheme);
        }

        themeToggle.addEventListener('click', toggleTheme);

        // Charger le theme au demarrage
        loadTheme();

        // Ecouter les changements de preference systeme
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('tdah-theme')) {
                const theme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                updateThemeIcon(theme);
            }
        });

        // =============================================
        // GESTION DE LA LANGUE FR/EN
        // =============================================
        const langToggle = document.getElementById('lang-toggle');
        const langIcon = document.getElementById('lang-icon');
        let currentLang = 'fr';

        const translations = {
            fr: {
                // Header
                'title': 'Assistant TDAH Intelligent',
                'subtitle': 'Decompose tes taches, gere ton temps et decouvre des conseils adaptes',
                // Tabs
                'tab-taches': 'Taches',
                'tab-pomodoro': 'Pomodoro',
                'tab-conseils': 'Conseils',
                'tab-connaitre': 'A connaitre',
                // Taches section
                'task-label': 'Decris ta tache :',
                'task-placeholder': 'Ex: Faire ma dissertation de francais sur le romantisme pour lundi...',
                'detail-level': 'Niveau de detail',
                'decompose-btn': 'Decomposer ma tache',
                'your-plan': 'Ton plan de travail',
                'steps': 'Etapes',
                'completed': 'Terminees',
                'progress': 'Progression',
                'connecting-ai': 'Connexion a l\'IA...',
                'ai-wait': 'Cela peut prendre jusqu\'a 45 secondes',
                // Spiciness levels
                'spicy-1': 'Minimaliste - 3-4 grandes etapes',
                'spicy-2': 'Simplifie - 4-6 etapes principales',
                'spicy-3': 'Equilibre - 6-8 etapes detaillees',
                'spicy-4': 'Detaille - 8-10 micro-etapes',
                'spicy-5': 'Ultra-detaille - 10-12 mini-etapes',
                // Pomodoro
                'pomodoro-title': 'Minuteur Pomodoro',
                'ready-work': 'Pret a travailler',
                'work-time': 'Travail (min)',
                'short-break': 'Pause courte (min)',
                'long-break': 'Pause longue (min)',
                'pomodoros-done': 'Pomodoros completes :',
                'start': 'Demarrer',
                'pause': 'Pause',
                'reset': 'Reinitialiser',
                'work-session': 'Temps de travail - Concentre-toi !',
                'break-session': 'Pause',
                'long-break-msg': 'Pause longue - Tu l\'as bien merite !',
                'short-break-msg': 'Pause courte - Detends-toi !',
                'paused': 'En pause',
                'notif-work': 'C\'est l\'heure de travailler !',
                'notif-break': 'Pause terminee, c\'est reparti !',
                // Conseils
                'conseils-title': 'Conseils TDAH',
                'all': 'Tous',
                'concentration': 'Concentration',
                'organisation': 'Organisation',
                'motivation': 'Motivation',
                'stress-management': 'Gestion du stress',
                'get-ai-conseil': 'Obtenir un conseil personnalise (IA)',
                // Conseil cards
                'conseil-1-title': 'La regle des 2 minutes',
                'conseil-1-text': 'Si une tache prend moins de 2 minutes, fais-la immediatement. Cela evite l\'accumulation de petites taches qui encombrent ton esprit.',
                'conseil-2-title': 'Un seul endroit pour tout noter',
                'conseil-2-text': 'Utilise un seul carnet ou une seule application pour toutes tes notes. Evite d\'eparpiller tes idees sur plusieurs supports.',
                'conseil-3-title': 'Elimine les distractions',
                'conseil-3-text': 'Mets ton telephone en mode avion, ferme les onglets inutiles, et previens ton entourage que tu travailles. Chaque interruption te coute 20 minutes de reconcentration.',
                'conseil-4-title': 'Recompense-toi',
                'conseil-4-text': 'Apres chaque tache accomplie, accorde-toi une petite recompense : une pause, un snack, ou quelques minutes sur ton activite preferee.',
                'conseil-5-title': 'La respiration 4-7-8',
                'conseil-5-text': 'Inspire pendant 4 secondes, retiens ta respiration 7 secondes, expire pendant 8 secondes. Repete 3 fois pour calmer rapidement ton anxiete.',
                'conseil-6-title': 'Prepare la veille',
                'conseil-6-text': 'Chaque soir, prepare tes affaires et note les 3 taches prioritaires du lendemain. Tu gagneras du temps et de l\'energie mentale le matin.',
                'conseil-7-title': 'Commence par le plus difficile',
                'conseil-7-text': 'Tackle ta tache la plus redoutee en premier, quand ton energie est au maximum. Le reste de la journee te semblera plus facile.',
                'conseil-8-title': 'Le body doubling',
                'conseil-8-text': 'Travaille en presence d\'une autre personne (meme en visio). La presence d\'autrui aide a maintenir la concentration et la motivation.',
                'conseil-9-title': 'Accepte l\'imperfection',
                'conseil-9-text': 'Mieux vaut une tache terminee a 80% qu\'une tache parfaite jamais finie. Le perfectionnisme est souvent l\'ennemi de la productivite.',
                'conseil-10-title': 'Utilise des alarmes',
                'conseil-10-text': 'Programme des rappels pour les taches importantes, les rendez-vous, et meme les pauses. Ton cerveau TDAH a besoin de signaux externes.',
                // A connaitre
                'revision-title': 'Fiches de revision personnalisees',
                'revision-label': 'Quel sujet veux-tu reviser ?',
                'revision-placeholder': 'Ex: La Revolution francaise, Les equations du second degre, Le romantisme en litterature, Les protocoles reseau TCP/IP...',
                'level-label': 'Ton niveau scolaire :',
                'level-college': 'College (6e - 3e)',
                'level-seconde': 'Seconde',
                'level-premiere': 'Premiere',
                'level-terminale': 'Terminale',
                'level-bts': 'BTS / DUT',
                'level-licence': 'Licence / Prepa',
                'generate-fiche': 'Generer ma fiche de revision',
                'dates-title': 'Dates importantes',
                'definitions-title': 'Definitions cles',
                'formulas-title': 'Formules essentielles',
                'keypoints-title': 'Points cles a retenir',
                'previous-fiches': 'Fiches precedentes',
                // Feedback
                'feedback-title': 'Ton avis sur cette fiche',
                'feedback-useful': 'Cette fiche t\'a ete utile ?',
                'feedback-improve': 'Qu\'est-ce qui pourrait etre ameliore ?',
                'feedback-simple': 'Trop simple',
                'feedback-complex': 'Trop complexe',
                'feedback-examples': 'Manque d\'exemples',
                'feedback-details': 'Manque de details',
                'feedback-long': 'Trop long',
                'feedback-short': 'Trop court',
                'feedback-formulas': 'Formules incorrectes',
                'feedback-perfect': 'Parfait !',
                'feedback-comment': 'Commentaire (optionnel) :',
                'feedback-comment-placeholder': 'Dis-nous ce qui manque ou ce qui pourrait etre mieux...',
                'send-feedback': 'Envoyer mon avis',
                'feedback-thanks': 'Merci pour ton retour ! On en tiendra compte pour les prochaines fiches.',
                'feedback-sent': 'Avis envoye !',
                'feedback-rate-alert': 'Merci de donner une note avec les etoiles !',
                // Alerts
                'alert-task': 'Decris ta tache avant de la decomposer !',
                'alert-subject': 'Indique le sujet que tu veux reviser !',
                // Toggle titles
                'switch-to-en': 'Switch to English',
                'switch-to-fr': 'Passer en francais',
                'switch-dark': 'Passer en mode sombre',
                'switch-light': 'Passer en mode clair'
            },
            en: {
                // Header
                'title': 'Smart ADHD Assistant',
                'subtitle': 'Break down your tasks, manage your time and discover adapted tips',
                // Tabs
                'tab-taches': 'Tasks',
                'tab-pomodoro': 'Pomodoro',
                'tab-conseils': 'Tips',
                'tab-connaitre': 'Study Cards',
                // Taches section
                'task-label': 'Describe your task:',
                'task-placeholder': 'Ex: Write my French essay about romanticism for Monday...',
                'detail-level': 'Detail level',
                'decompose-btn': 'Break down my task',
                'your-plan': 'Your work plan',
                'steps': 'Steps',
                'completed': 'Completed',
                'progress': 'Progress',
                'connecting-ai': 'Connecting to AI...',
                'ai-wait': 'This may take up to 45 seconds',
                // Spiciness levels
                'spicy-1': 'Minimalist - 3-4 main steps',
                'spicy-2': 'Simplified - 4-6 main steps',
                'spicy-3': 'Balanced - 6-8 detailed steps',
                'spicy-4': 'Detailed - 8-10 micro-steps',
                'spicy-5': 'Ultra-detailed - 10-12 mini-steps',
                // Pomodoro
                'pomodoro-title': 'Pomodoro Timer',
                'ready-work': 'Ready to work',
                'work-time': 'Work (min)',
                'short-break': 'Short break (min)',
                'long-break': 'Long break (min)',
                'pomodoros-done': 'Completed pomodoros:',
                'start': 'Start',
                'pause': 'Pause',
                'reset': 'Reset',
                'work-session': 'Work time - Stay focused!',
                'break-session': 'Break',
                'long-break-msg': 'Long break - You earned it!',
                'short-break-msg': 'Short break - Relax!',
                'paused': 'Paused',
                'notif-work': 'Time to work!',
                'notif-break': 'Break is over, let\'s go!',
                // Conseils
                'conseils-title': 'ADHD Tips',
                'all': 'All',
                'concentration': 'Focus',
                'organisation': 'Organization',
                'motivation': 'Motivation',
                'stress-management': 'Stress Management',
                'get-ai-conseil': 'Get a personalized tip (AI)',
                // Conseil cards
                'conseil-1-title': 'The 2-minute rule',
                'conseil-1-text': 'If a task takes less than 2 minutes, do it immediately. This prevents small tasks from piling up and cluttering your mind.',
                'conseil-2-title': 'One place for all notes',
                'conseil-2-text': 'Use a single notebook or app for all your notes. Avoid scattering your ideas across multiple platforms.',
                'conseil-3-title': 'Eliminate distractions',
                'conseil-3-text': 'Put your phone on airplane mode, close unnecessary tabs, and let others know you\'re working. Each interruption costs you 20 minutes to refocus.',
                'conseil-4-title': 'Reward yourself',
                'conseil-4-text': 'After completing each task, give yourself a small reward: a break, a snack, or a few minutes on your favorite activity.',
                'conseil-5-title': 'The 4-7-8 breathing',
                'conseil-5-text': 'Inhale for 4 seconds, hold your breath for 7 seconds, exhale for 8 seconds. Repeat 3 times to quickly calm your anxiety.',
                'conseil-6-title': 'Prepare the night before',
                'conseil-6-text': 'Each evening, prepare your things and note the 3 priority tasks for tomorrow. You\'ll save time and mental energy in the morning.',
                'conseil-7-title': 'Start with the hardest',
                'conseil-7-text': 'Tackle your most dreaded task first, when your energy is at its peak. The rest of the day will feel easier.',
                'conseil-8-title': 'Body doubling',
                'conseil-8-text': 'Work in the presence of another person (even via video call). The presence of others helps maintain focus and motivation.',
                'conseil-9-title': 'Accept imperfection',
                'conseil-9-text': 'A task completed at 80% is better than a perfect task never finished. Perfectionism is often the enemy of productivity.',
                'conseil-10-title': 'Use alarms',
                'conseil-10-text': 'Set reminders for important tasks, appointments, and even breaks. Your ADHD brain needs external signals.',
                // A connaitre
                'revision-title': 'Personalized study cards',
                'revision-label': 'What subject do you want to study?',
                'revision-placeholder': 'Ex: The French Revolution, Quadratic equations, Romanticism in literature, TCP/IP network protocols...',
                'level-label': 'Your education level:',
                'level-college': 'Middle School',
                'level-seconde': '10th Grade',
                'level-premiere': '11th Grade',
                'level-terminale': '12th Grade',
                'level-bts': 'Associate Degree',
                'level-licence': 'Bachelor / Prep',
                'generate-fiche': 'Generate my study card',
                'dates-title': 'Important dates',
                'definitions-title': 'Key definitions',
                'formulas-title': 'Essential formulas',
                'keypoints-title': 'Key points to remember',
                'previous-fiches': 'Previous cards',
                // Feedback
                'feedback-title': 'Your feedback on this card',
                'feedback-useful': 'Was this card helpful?',
                'feedback-improve': 'What could be improved?',
                'feedback-simple': 'Too simple',
                'feedback-complex': 'Too complex',
                'feedback-examples': 'Needs examples',
                'feedback-details': 'Needs more details',
                'feedback-long': 'Too long',
                'feedback-short': 'Too short',
                'feedback-formulas': 'Incorrect formulas',
                'feedback-perfect': 'Perfect!',
                'feedback-comment': 'Comment (optional):',
                'feedback-comment-placeholder': 'Tell us what\'s missing or what could be better...',
                'send-feedback': 'Send my feedback',
                'feedback-thanks': 'Thanks for your feedback! We\'ll take it into account for future cards.',
                'feedback-sent': 'Feedback sent!',
                'feedback-rate-alert': 'Please rate with the stars!',
                // Alerts
                'alert-task': 'Describe your task before breaking it down!',
                'alert-subject': 'Enter the subject you want to study!',
                // Toggle titles
                'switch-to-en': 'Switch to English',
                'switch-to-fr': 'Passer en francais',
                'switch-dark': 'Switch to dark mode',
                'switch-light': 'Switch to light mode'
            }
        };

        function loadLang() {
            const savedLang = localStorage.getItem('tdah-lang') || 'fr';
            currentLang = savedLang;
            applyTranslations(savedLang);
            updateLangIcon(savedLang);
        }

        function updateLangIcon(lang) {
            if (lang === 'fr') {
                langIcon.textContent = 'EN';
                langToggle.title = translations.fr['switch-to-en'];
            } else {
                langIcon.textContent = 'FR';
                langToggle.title = translations.en['switch-to-fr'];
            }
        }

        function toggleLang() {
            currentLang = currentLang === 'fr' ? 'en' : 'fr';
            localStorage.setItem('tdah-lang', currentLang);
            applyTranslations(currentLang);
            updateLangIcon(currentLang);
        }

        function applyTranslations(lang) {
            const t = translations[lang];

            // Helper function pour eviter les erreurs null
            const setText = (selector, key) => {
                const el = document.querySelector(selector);
                if (el && t[key]) el.textContent = t[key];
            };
            const setTextById = (id, key) => {
                const el = document.getElementById(id);
                if (el && t[key]) el.textContent = t[key];
            };
            const setPlaceholder = (id, key) => {
                const el = document.getElementById(id);
                if (el && t[key]) el.placeholder = t[key];
            };

            // Title et subtitle
            setText('header h1', 'title');
            setText('header p', 'subtitle');
            document.title = t['title'];

            // Tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                const tabName = tab.dataset.tab;
                if (tabName === 'taches') tab.textContent = t['tab-taches'];
                if (tabName === 'pomodoro') tab.textContent = t['tab-pomodoro'];
                if (tabName === 'conseils') tab.textContent = t['tab-conseils'];
                if (tabName === 'connaitre') tab.textContent = t['tab-connaitre'];
            });

            // Taches section
            setText('label[for="task-input"]', 'task-label');
            setPlaceholder('task-input', 'task-placeholder');
            setText('.spiciness-label span:first-child', 'detail-level');
            setTextById('decompose-btn', 'decompose-btn');
            setText('.results-header h2', 'your-plan');

            // Stats labels
            const statLabels = document.querySelectorAll('.stat-label');
            if (statLabels[0]) statLabels[0].textContent = t['steps'];
            if (statLabels[1]) statLabels[1].textContent = t['completed'];
            if (statLabels[2]) statLabels[2].textContent = t['progress'];

            // Loading
            const loadingP = document.querySelectorAll('#loading p');
            if (loadingP[0]) loadingP[0].textContent = t['connecting-ai'];
            if (loadingP[1]) loadingP[1].textContent = t['ai-wait'];

            // Pomodoro
            setText('#tab-pomodoro h2', 'pomodoro-title');
            setTextById('timer-status', 'ready-work');
            setTextById('btn-start', 'start');
            setTextById('btn-pause', 'pause');
            setTextById('btn-reset', 'reset');

            const settingLabels = document.querySelectorAll('.setting-item label');
            if (settingLabels[0]) settingLabels[0].textContent = t['work-time'];
            if (settingLabels[1]) settingLabels[1].textContent = t['short-break'];
            if (settingLabels[2]) settingLabels[2].textContent = t['long-break'];

            const pomodoroCountEl = document.querySelector('.pomodoro-count');
            if (pomodoroCountEl) {
                const countSpan = pomodoroCountEl.querySelector('span');
                const countValue = countSpan ? countSpan.textContent : '0';
                pomodoroCountEl.innerHTML = t['pomodoros-done'] + ' <span id="pomodoro-count">' + countValue + '</span>';
            }

            // Conseils
            setText('#tab-conseils h2', 'conseils-title');
            setTextById('btn-new-conseil', 'get-ai-conseil');

            const categoryBtns = document.querySelectorAll('.category-btn');
            categoryBtns.forEach(btn => {
                const cat = btn.dataset.category;
                if (cat === 'tous') btn.textContent = t['all'];
                if (cat === 'concentration') btn.textContent = t['concentration'];
                if (cat === 'organisation') btn.textContent = t['organisation'];
                if (cat === 'motivation') btn.textContent = t['motivation'];
                if (cat === 'gestion-stress') btn.textContent = t['stress-management'];
            });

            // Conseil cards
            const conseilCards = document.querySelectorAll('.conseil-card');
            conseilCards.forEach((card, index) => {
                const h3 = card.querySelector('h3');
                const p = card.querySelector('p');
                const num = index + 1;
                if (h3 && t['conseil-' + num + '-title']) h3.textContent = t['conseil-' + num + '-title'];
                if (p && t['conseil-' + num + '-text']) p.textContent = t['conseil-' + num + '-text'];
            });

            // A connaitre
            setText('#tab-connaitre h2', 'revision-title');
            setText('label[for="revision-input"]', 'revision-label');
            setPlaceholder('revision-input', 'revision-placeholder');
            setText('label[for="niveau-select"]', 'level-label');

            const niveauOptions = document.querySelectorAll('#niveau-select option');
            const levelKeys = ['level-college', 'level-seconde', 'level-premiere', 'level-terminale', 'level-bts', 'level-licence'];
            niveauOptions.forEach((opt, i) => {
                if (levelKeys[i] && t[levelKeys[i]]) opt.textContent = t[levelKeys[i]];
            });

            setTextById('btn-generate-fiche', 'generate-fiche');

            // Fiche loading
            const ficheLoadingP = document.querySelectorAll('#fiche-loading p');
            if (ficheLoadingP[0]) ficheLoadingP[0].textContent = t['connecting-ai'];
            if (ficheLoadingP[1]) ficheLoadingP[1].textContent = t['ai-wait'];

            // Fiche titles
            const ficheDatesTitle = document.querySelector('#fiche-dates .frise-title');
            if (ficheDatesTitle) ficheDatesTitle.innerHTML = '&#128197; ' + t['dates-title'];
            const ficheDefsTitle = document.querySelector('#fiche-definitions .frise-title');
            if (ficheDefsTitle) ficheDefsTitle.innerHTML = '&#128213; ' + t['definitions-title'];
            const ficheFormTitle = document.querySelector('#fiche-formules .frise-title');
            if (ficheFormTitle) ficheFormTitle.innerHTML = '&#128290; ' + t['formulas-title'];
            const fichePointsTitle = document.querySelector('#fiche-points .frise-title');
            if (fichePointsTitle) fichePointsTitle.innerHTML = '&#128161; ' + t['keypoints-title'];

            // Feedback section
            const feedbackTitle = document.querySelector('#fiche-feedback .frise-title');
            if (feedbackTitle) feedbackTitle.innerHTML = '&#128172; ' + t['feedback-title'];

            const feedbackUseful = document.querySelector('.feedback-rating span');
            if (feedbackUseful) feedbackUseful.textContent = t['feedback-useful'];

            const feedbackImprove = document.querySelector('.feedback-options span');
            if (feedbackImprove) feedbackImprove.textContent = t['feedback-improve'];

            const feedbackTagsEl = document.querySelectorAll('.feedback-tag');
            const tagKeys = ['feedback-simple', 'feedback-complex', 'feedback-examples', 'feedback-details', 'feedback-long', 'feedback-short', 'feedback-formulas', 'feedback-perfect'];
            feedbackTagsEl.forEach((tag, i) => {
                if (tagKeys[i] && t[tagKeys[i]]) tag.textContent = t[tagKeys[i]];
            });

            const feedbackCommentLabel = document.querySelector('.feedback-comment label');
            if (feedbackCommentLabel) feedbackCommentLabel.textContent = t['feedback-comment'];
            const feedbackTextEl = document.getElementById('feedback-text');
            if (feedbackTextEl) feedbackTextEl.placeholder = t['feedback-comment-placeholder'];

            const btnFeedback = document.getElementById('btn-submit-feedback');
            if (btnFeedback) {
                if (!btnFeedback.disabled) {
                    btnFeedback.textContent = t['send-feedback'];
                } else {
                    btnFeedback.textContent = t['feedback-sent'];
                }
            }

            const feedbackSuccessEl = document.getElementById('feedback-success');
            if (feedbackSuccessEl) feedbackSuccessEl.textContent = t['feedback-thanks'];

            // Historique
            const historiqueTitle = document.querySelector('#fiches-historique h3');
            if (historiqueTitle) historiqueTitle.textContent = t['previous-fiches'];

            // Update spiciness display
            updateSpicinessDisplay();
        }

        function updateSpicinessDisplay() {
            const slider = document.getElementById('spiciness-slider');
            const display = document.getElementById('spiciness-display');
            if (slider && display) {
                const value = slider.value;
                const t = translations[currentLang];
                display.textContent = t['spicy-' + value];
            }
        }

        langToggle.addEventListener('click', toggleLang);

        const SPICINESS_CONFIG = {
            1: { label: "Minimaliste", emoji: "", description: "3-4 grandes etapes" },
            2: { label: "Simplifie", emoji: "", description: "4-6 etapes principales" },
            3: { label: "Equilibre", emoji: "", description: "6-8 etapes detaillees" },
            4: { label: "Detaille", emoji: "", description: "8-10 micro-etapes" },
            5: { label: "Ultra-detaille", emoji: "", description: "10-12 mini-etapes" }
        };

        // =============================================
        // FONCTION PUTER.AI AVEC TIMEOUT ET RETRY
        // =============================================
        const PUTER_TIMEOUT = 45000; // 45 secondes max
        const PUTER_RETRY_COUNT = 2; // 2 tentatives max

        async function puterAiChatWithTimeout(prompt, timeoutMs = PUTER_TIMEOUT) {
            // Verifier que puter est disponible
            if (typeof puter === 'undefined') {
                throw new Error('Puter.js non charge. Verifie ta connexion internet et rafraichis la page.');
            }

            // Creer une promesse avec timeout
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => {
                    reject(new Error('Delai depasse (45s). Le service IA est peut-etre surcharge. Reessaie dans quelques instants.'));
                }, timeoutMs);
            });

            // Executer la requete avec timeout
            const response = await Promise.race([
                puter.ai.chat(prompt),
                timeoutPromise
            ]);

            return response;
        }

        async function puterAiChatWithRetry(prompt, loadingElement = null) {
            let lastError = null;
            const loadingMessages = [
                'Connexion a l\'IA...',
                'Generation en cours...',
                'L\'IA reflechit...',
                'Encore un instant...',
                'Presque termine...'
            ];
            let messageIndex = 0;
            let loadingInterval = null;

            // Afficher des messages progressifs
            if (loadingElement) {
                loadingInterval = setInterval(() => {
                    const loadingText = loadingElement.querySelector('p');
                    if (loadingText && messageIndex < loadingMessages.length) {
                        loadingText.textContent = loadingMessages[messageIndex];
                        messageIndex++;
                    }
                }, 8000);
            }

            try {
                for (let attempt = 1; attempt <= PUTER_RETRY_COUNT; attempt++) {
                    try {
                        console.log(`Tentative ${attempt}/${PUTER_RETRY_COUNT}...`);
                        const response = await puterAiChatWithTimeout(prompt);
                        return response;
                    } catch (error) {
                        lastError = error;
                        console.warn(`Tentative ${attempt} echouee:`, error.message);
                        if (attempt < PUTER_RETRY_COUNT) {
                            // Attendre 2 secondes avant de reessayer
                            await new Promise(r => setTimeout(r, 2000));
                        }
                    }
                }
                throw lastError;
            } finally {
                if (loadingInterval) {
                    clearInterval(loadingInterval);
                }
            }
        }

        const spicinessSlider = document.getElementById('spiciness-slider');
        const spicinessValue = document.getElementById('spiciness-value');
        const spicinessDisplay = document.getElementById('spiciness-display');
        const taskInput = document.getElementById('task-input');
        const decomposeBtn = document.getElementById('decompose-btn');
        const resultsSection = document.getElementById('results-section');
        const loading = document.getElementById('loading');
        const resultsContent = document.getElementById('results-content');
        const taskList = document.getElementById('task-list');
        const errorMessage = document.getElementById('error-message');

        let tasks = [];

        spicinessSlider.addEventListener('input', () => {
            const value = spicinessSlider.value;
            spicinessValue.textContent = value;
            updateSpicinessDisplay();
        });

        decomposeBtn.addEventListener('click', async () => {
            const task = taskInput.value.trim();
            if (!task) {
                alert(translations[currentLang]['alert-task']);
                return;
            }

            resultsSection.classList.add('visible');
            loading.style.display = 'block';
            resultsContent.style.display = 'none';
            errorMessage.style.display = 'none';
            decomposeBtn.disabled = true;

            try {
                const spiciness = parseInt(spicinessSlider.value);
                const config = SPICINESS_CONFIG[spiciness];

                const prompt = `Tu es un expert en decomposition de taches pour personnes TDAH.

NIVEAU DE DETAIL : ${config.label} (${config.description})

TACHE A DECOMPOSER :
"${task}"

REGLES ABSOLUES :
1. Entre ${spiciness + 2} et ${spiciness + 7} etapes maximum
2. UN verbe d'action au debut de chaque etape
3. Phrases courtes (10 mots max)
4. Ordre logique progressif
5. Adapte au niveau scolaire francais

REPONDS UNIQUEMENT avec la liste numerotee, rien d'autre :
1. [ACTION]
2. [ACTION]
...`;

                console.log('Envoi du prompt a Puter...');

                const response = await puterAiChatWithRetry(prompt, loading);
                console.log('Reponse brute:', response);
                console.log('Type de reponse:', typeof response);
                console.log('Cles de response:', response ? Object.keys(response) : 'null');

                // Puter.js v2 retourne un objet avec message.content
                let text = '';
                if (typeof response === 'string') {
                    text = response;
                } else if (response?.message?.content) {
                    text = response.message.content;
                } else if (response?.text) {
                    text = response.text;
                } else if (response?.content) {
                    text = response.content;
                } else if (response?.choices?.[0]?.message?.content) {
                    text = response.choices[0].message.content;
                } else {
                    // Dernier recours: chercher n'importe quelle string dans l'objet
                    const str = JSON.stringify(response);
                    console.log('Response stringify:', str);
                    text = str;
                }

                console.log('Texte extrait:', text);

                if (!text || text === '{}' || text === 'undefined' || text === 'null') {
                    throw new Error('Reponse vide. Assure-toi d\'etre connecte a Puter (popup de connexion).');
                }

                tasks = parseResponse(text);
                hasShownCelebration = false; // Reinitialiser pour la nouvelle liste
                console.log('Taches parsees:', tasks);

                if (tasks.length === 0) {
                    // Essayer de parser meme sans numeros
                    const lines = text.split('\n').filter(l => l.trim().length > 5);
                    if (lines.length > 0) {
                        tasks = lines.slice(0, 10).map((line, i) => ({
                            id: i + 1,
                            title: line.replace(/^[\d\.\-\*]+\s*/, '').trim(),
                            completed: false
                        }));
                    }
                }

                if (tasks.length === 0) {
                    throw new Error('Parsing echoue. Reponse brute: ' + text.substring(0, 300));
                }

                displayTasks(tasks);

                loading.style.display = 'none';
                resultsContent.style.display = 'block';

            } catch (error) {
                console.error('Erreur:', error);
                loading.style.display = 'none';
                errorMessage.textContent = `Erreur: ${error.message}`;
                errorMessage.style.display = 'block';
            }

            decomposeBtn.disabled = false;
        });

        function parseResponse(text) {
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => /^\d+\./.test(line))
                .map(line => line.replace(/^\d+\.\s*/, ''));

            return lines.map((title, index) => ({
                id: index + 1,
                title: title,
                completed: false
            }));
        }

        function displayTasks(tasks) {
            taskList.innerHTML = '';

            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'task-item' + (task.completed ? ' completed' : '');
                li.innerHTML = `
                    <div class="task-number">${index + 1}</div>
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} data-index="${index}">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                    </div>
                `;
                taskList.appendChild(li);
            });

            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    tasks[index].completed = e.target.checked;
                    e.target.closest('.task-item').classList.toggle('completed', e.target.checked);
                    updateStats();
                });
            });

            updateStats();
        }

        let hasShownCelebration = false;

        function updateStats() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('total-tasks').textContent = total;
            document.getElementById('completed-tasks').textContent = completed;
            document.getElementById('progress').textContent = progress + '%';
            document.getElementById('task-count').textContent = `${completed}/${total} terminees`;

            // Verifier si toutes les taches sont completees
            if (total > 0 && completed === total && !hasShownCelebration) {
                hasShownCelebration = true;
                showCelebration();
            }
        }

        function showCelebration() {
            // Creer les confettis
            createConfetti();

            // Creer l'overlay de felicitations
            const overlay = document.createElement('div');
            overlay.className = 'celebration-overlay';
            overlay.id = 'celebration-overlay';

            const messages = [
                { emoji: '', title: 'Bravo !', message: 'Tu as termine toutes tes taches !' },
                { emoji: '', title: 'Champion !', message: 'Toutes les etapes sont completees !' },
                { emoji: '', title: 'Excellent !', message: 'Mission accomplie avec succes !' },
                { emoji: '', title: 'Incroyable !', message: 'Tu as tout dechire !' },
                { emoji: '', title: 'Super travail !', message: 'Tu peux etre fier de toi !' }
            ];

            const randomMessage = messages[Math.floor(Math.random() * messages.length)];

            overlay.innerHTML = `
                <div class="celebration-content">
                    <div class="celebration-emoji">${randomMessage.emoji}</div>
                    <div class="celebration-title">${randomMessage.title}</div>
                    <div class="celebration-message">${randomMessage.message}</div>
                    <button class="celebration-close" onclick="closeCelebration()">Continuer</button>
                </div>
            `;

            document.body.appendChild(overlay);

            // Jouer un son de celebration
            playCelebrationSound();
        }

        function closeCelebration() {
            const overlay = document.getElementById('celebration-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => overlay.remove(), 300);
            }
            // Supprimer les confettis
            document.querySelectorAll('.confetti').forEach(c => c.remove());
        }

        function createConfetti() {
            const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#fa709a', '#fee140'];

            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = (Math.random() * 10 + 5) + 'px';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(confetti);

                    // Supprimer apres l'animation
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 50);
            }
        }

        function playCelebrationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Jouer une melodie simple
                const notes = [523.25, 659.25, 783.99, 1046.50]; // Do Mi Sol Do (octave superieure)
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.value = freq;
                        oscillator.type = 'sine';

                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    }, i * 150);
                });
            } catch (e) {
                console.log('Son non disponible');
            }
        }

        // Initialiser l'affichage du spiciness
        spicinessSlider.dispatchEvent(new Event('input'));

        // =============================================
        // NAVIGATION PAR ONGLETS
        // =============================================
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `tab-${targetTab}`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // =============================================
        // MINUTEUR POMODORO
        // =============================================
        let pomodoroInterval = null;
        let pomodoroTimeLeft = 25 * 60;
        let pomodoroIsRunning = false;
        let pomodoroMode = 'work'; // 'work', 'shortBreak', 'longBreak'
        let pomodoroCount = 0;

        const timerDisplay = document.getElementById('timer-display');
        const timerStatus = document.getElementById('timer-status');
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnReset = document.getElementById('btn-reset');
        const workDurationInput = document.getElementById('work-duration');
        const shortBreakInput = document.getElementById('short-break');
        const longBreakInput = document.getElementById('long-break');
        const pomodoroCountDisplay = document.getElementById('pomodoro-count');

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(pomodoroTimeLeft);
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Son non disponible');
            }
        }

        function startPomodoro() {
            pomodoroIsRunning = true;
            btnStart.style.display = 'none';
            btnPause.style.display = 'inline-block';

            // Update status text based on current mode
            const t = translations[currentLang];
            if (pomodoroMode === 'work') {
                timerStatus.textContent = t['work-session'];
                timerStatus.className = 'timer-status work';
            } else {
                timerStatus.textContent = pomodoroMode === 'longBreak' ? t['long-break-msg'] : t['short-break-msg'];
                timerStatus.className = 'timer-status break';
            }

            pomodoroInterval = setInterval(() => {
                pomodoroTimeLeft--;
                updateTimerDisplay();

                if (pomodoroTimeLeft <= 0) {
                    clearInterval(pomodoroInterval);
                    playNotificationSound();

                    if (pomodoroMode === 'work') {
                        pomodoroCount++;
                        pomodoroCountDisplay.textContent = pomodoroCount;

                        const t = translations[currentLang];
                        if (pomodoroCount % 4 === 0) {
                            pomodoroMode = 'longBreak';
                            pomodoroTimeLeft = parseInt(longBreakInput.value) * 60;
                            timerStatus.textContent = t['long-break-msg'];
                            timerStatus.className = 'timer-status break';
                        } else {
                            pomodoroMode = 'shortBreak';
                            pomodoroTimeLeft = parseInt(shortBreakInput.value) * 60;
                            timerStatus.textContent = t['short-break-msg'];
                            timerStatus.className = 'timer-status break';
                        }
                    } else {
                        const t = translations[currentLang];
                        pomodoroMode = 'work';
                        pomodoroTimeLeft = parseInt(workDurationInput.value) * 60;
                        timerStatus.textContent = t['work-session'];
                        timerStatus.className = 'timer-status work';
                    }

                    updateTimerDisplay();
                    pomodoroIsRunning = false;
                    btnStart.style.display = 'inline-block';
                    btnPause.style.display = 'none';

                    if (Notification.permission === 'granted') {
                        const t = translations[currentLang];
                        new Notification('Pomodoro', {
                            body: pomodoroMode === 'work' ? t['notif-work'] : t['notif-break'],
                            icon: ''
                        });
                    }
                }
            }, 1000);
        }

        function pausePomodoro() {
            pomodoroIsRunning = false;
            clearInterval(pomodoroInterval);
            btnStart.style.display = 'inline-block';
            btnPause.style.display = 'none';
            timerStatus.textContent = translations[currentLang]['paused'];
        }

        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            pomodoroIsRunning = false;
            pomodoroMode = 'work';
            pomodoroTimeLeft = parseInt(workDurationInput.value) * 60;
            updateTimerDisplay();
            btnStart.style.display = 'inline-block';
            btnPause.style.display = 'none';
            timerStatus.textContent = translations[currentLang]['ready-work'];
            timerStatus.className = 'timer-status';
        }

        btnStart.addEventListener('click', startPomodoro);
        btnPause.addEventListener('click', pausePomodoro);
        btnReset.addEventListener('click', resetPomodoro);

        workDurationInput.addEventListener('change', () => {
            if (!pomodoroIsRunning && pomodoroMode === 'work') {
                pomodoroTimeLeft = parseInt(workDurationInput.value) * 60;
                updateTimerDisplay();
            }
        });

        // Demander la permission pour les notifications
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // =============================================
        // SECTION CONSEILS
        // =============================================
        const categoryButtons = document.querySelectorAll('.category-btn');
        const conseilCards = document.querySelectorAll('.conseil-card');
        const btnNewConseil = document.getElementById('btn-new-conseil');
        const conseilIaContainer = document.getElementById('conseil-ia');

        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.dataset.category;

                categoryButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                conseilCards.forEach(card => {
                    if (category === 'tous' || card.dataset.category === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        btnNewConseil.addEventListener('click', async () => {
            btnNewConseil.disabled = true;
            btnNewConseil.textContent = 'Generation en cours...';

            conseilIaContainer.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>L'IA reflechit a un conseil pour toi...</p>
                </div>
            `;

            try {
                const prompt = `Tu es un coach specialise dans l'accompagnement des personnes TDAH.

Donne UN SEUL conseil pratique et actionnable pour aider quelqu'un avec un TDAH a mieux gerer son quotidien.

REGLES :
- Le conseil doit etre NOUVEAU et ORIGINAL
- Maximum 3 phrases
- Langage simple et bienveillant
- Tutoiement
- Inclus une technique concrete

REPONDS avec ce format exact :
TITRE: [titre court du conseil]
CONSEIL: [ton conseil]`;

                const conseilLoading = conseilIaContainer.querySelector('.loading');
                const response = await puterAiChatWithRetry(prompt, conseilLoading);

                let text = '';
                if (typeof response === 'string') {
                    text = response;
                } else if (response && response.message && response.message.content) {
                    text = response.message.content;
                } else if (response && typeof response.toString === 'function') {
                    text = response.toString();
                }

                const titleMatch = text.match(/TITRE:\s*(.+)/i);
                const conseilMatch = text.match(/CONSEIL:\s*(.+)/is);

                const title = titleMatch ? titleMatch[1].trim() : 'Conseil du jour';
                const conseil = conseilMatch ? conseilMatch[1].trim() : text;

                conseilIaContainer.innerHTML = `
                    <div class="conseil-card" style="border-left-color: #4CAF50;">
                        <h3> ${title}</h3>
                        <p>${conseil}</p>
                    </div>
                `;

            } catch (error) {
                conseilIaContainer.innerHTML = `
                    <div class="error">
                        Erreur lors de la generation du conseil : ${error.message}
                    </div>
                `;
            }

            btnNewConseil.disabled = false;
            btnNewConseil.textContent = 'Obtenir un conseil personnalise (IA)';
        });

        // =============================================
        // SECTION A CONNAITRE - FICHES DYNAMIQUES
        // =============================================
        const revisionInput = document.getElementById('revision-input');
        const niveauSelect = document.getElementById('niveau-select');
        const btnGenerateFiche = document.getElementById('btn-generate-fiche');

        // Sauvegarder le niveau choisi
        const savedNiveau = localStorage.getItem('niveau-scolaire');
        if (savedNiveau) {
            niveauSelect.value = savedNiveau;
        }
        niveauSelect.addEventListener('change', () => {
            localStorage.setItem('niveau-scolaire', niveauSelect.value);
        });
        const ficheLoading = document.getElementById('fiche-loading');
        const ficheContent = document.getElementById('fiche-content');
        const ficheError = document.getElementById('fiche-error');
        const fichesHistorique = document.getElementById('fiches-historique');
        const historiqueList = document.getElementById('historique-list');

        // Elements pour afficher le contenu
        const ficheDates = document.getElementById('fiche-dates');
        const ficheDefinitions = document.getElementById('fiche-definitions');
        const ficheFormules = document.getElementById('fiche-formules');
        const fichePoints = document.getElementById('fiche-points');
        const friseList = document.getElementById('frise-list');
        const definitionsList = document.getElementById('definitions-list');
        const formulesList = document.getElementById('formules-list');
        const pointsList = document.getElementById('points-list');

        // Historique des fiches
        let fichesHistory = JSON.parse(localStorage.getItem('fiches-history') || '[]');

        function updateHistoriqueDisplay() {
            if (fichesHistory.length === 0) {
                fichesHistorique.style.display = 'none';
                return;
            }

            fichesHistorique.style.display = 'block';
            historiqueList.innerHTML = '';

            fichesHistory.slice(-5).reverse().forEach((fiche, index) => {
                const btn = document.createElement('button');
                btn.className = 'category-btn';
                btn.textContent = fiche.sujet.substring(0, 25) + (fiche.sujet.length > 25 ? '...' : '');
                btn.title = fiche.sujet;
                btn.addEventListener('click', () => {
                    displayFicheData(fiche.data);
                    ficheContent.style.display = 'block';
                });
                historiqueList.appendChild(btn);
            });
        }

        updateHistoriqueDisplay();

        function displayFicheData(data) {
            // Reset all sections
            ficheDates.style.display = 'none';
            ficheDefinitions.style.display = 'none';
            ficheFormules.style.display = 'none';
            fichePoints.style.display = 'none';
            friseList.innerHTML = '';
            definitionsList.innerHTML = '';
            formulesList.innerHTML = '';
            pointsList.innerHTML = '';

            // Afficher les dates si presentes
            if (data.dates && data.dates.length > 0) {
                ficheDates.style.display = 'block';
                data.dates.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'frise-item';
                    div.innerHTML = `
                        <div class="frise-date">${item.date}</div>
                        <div class="frise-event">${item.evenement}</div>
                        ${item.detail ? `<div class="frise-detail">${item.detail}</div>` : ''}
                    `;
                    friseList.appendChild(div);
                });
            }

            // Afficher les definitions si presentes
            if (data.definitions && data.definitions.length > 0) {
                ficheDefinitions.style.display = 'block';
                data.definitions.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'definition-card';
                    div.innerHTML = `
                        <div class="definition-term">${item.terme}</div>
                        <div class="definition-text">${item.definition}</div>
                    `;
                    definitionsList.appendChild(div);
                });
            }

            // Afficher les formules si presentes
            if (data.formules && data.formules.length > 0) {
                ficheFormules.style.display = 'block';
                data.formules.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'formule-card';
                    div.innerHTML = `
                        <div class="formule-name">${item.nom}</div>
                        <div class="formule-expression">${item.formule}</div>
                        ${item.description ? `<div class="formule-description">${item.description}</div>` : ''}
                    `;
                    formulesList.appendChild(div);
                });
            }

            // Afficher les points cles si presents
            if (data.points && data.points.length > 0) {
                fichePoints.style.display = 'block';
                data.points.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'definition-card';
                    div.style.borderLeftColor = '#667eea';
                    div.innerHTML = `
                        <div class="definition-term" style="color: #667eea;">${item.titre}</div>
                        <div class="definition-text">${item.contenu}</div>
                    `;
                    pointsList.appendChild(div);
                });
            }
        }

        // Charger les feedbacks pour les utiliser dans le prompt
        let feedbackData = JSON.parse(localStorage.getItem('fiches-feedback') || '[]');

        // Fonction pour analyser les feedbacks et generer des instructions
        function getFeedbackInstructions() {
            if (feedbackData.length === 0) return '';

            const niveau = niveauSelect.value;
            const relevantFeedback = feedbackData.filter(f => f.niveau === niveau);

            if (relevantFeedback.length === 0) return '';

            // Compter les tags
            const tagCounts = {};
            relevantFeedback.forEach(f => {
                f.tags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });

            // Note moyenne
            const avgRating = relevantFeedback.reduce((sum, f) => sum + f.rating, 0) / relevantFeedback.length;

            // Generer les instructions basees sur les feedbacks
            let instructions = '\n\nBASE SUR LES RETOURS PRECEDENTS DE L\'UTILISATEUR :\n';

            if ((tagCounts['trop-simple'] || 0) > (tagCounts['trop-complexe'] || 0)) {
                instructions += '- Augmente le niveau de difficulte et la profondeur des explications\n';
            } else if ((tagCounts['trop-complexe'] || 0) > (tagCounts['trop-simple'] || 0)) {
                instructions += '- Simplifie les explications, utilise un vocabulaire plus accessible\n';
            }

            if ((tagCounts['manque-exemples'] || 0) >= 1) {
                instructions += '- AJOUTE DES EXEMPLES CONCRETS pour chaque concept\n';
            }

            if ((tagCounts['manque-details'] || 0) >= 1) {
                instructions += '- Developpe davantage les explications avec plus de details\n';
            }

            if ((tagCounts['trop-long'] || 0) > (tagCounts['trop-court'] || 0)) {
                instructions += '- Sois plus concis, va a l\'essentiel\n';
            } else if ((tagCounts['trop-court'] || 0) > (tagCounts['trop-long'] || 0)) {
                instructions += '- Developpe davantage chaque point\n';
            }

            if ((tagCounts['formules-incorrectes'] || 0) > 0) {
                instructions += '- VERIFIE ATTENTIVEMENT l\'exactitude des formules\n';
            }

            if (avgRating < 3) {
                instructions += '- L\'utilisateur a donne des notes basses, ameliore significativement la qualite\n';
            }

            // Ajouter les derniers commentaires pertinents
            const recentComments = relevantFeedback
                .filter(f => f.comment && f.comment.length > 10)
                .slice(-3)
                .map(f => f.comment);

            if (recentComments.length > 0) {
                instructions += '\nCOMMENTAIRES RECENTS DE L\'UTILISATEUR :\n';
                recentComments.forEach(c => {
                    instructions += `- "${c}"\n`;
                });
            }

            return instructions;
        }

        // Variable pour stocker le sujet actuel
        let currentFicheSubject = '';

        btnGenerateFiche.addEventListener('click', async () => {
            const sujet = revisionInput.value.trim();
            currentFicheSubject = sujet;
            if (!sujet) {
                alert(translations[currentLang]['alert-subject']);
                return;
            }

            ficheLoading.style.display = 'block';
            ficheContent.style.display = 'none';
            ficheError.style.display = 'none';
            btnGenerateFiche.disabled = true;

            try {
                const niveau = niveauSelect.value;
                const niveauLabels = {
                    'college': 'College (6e-3e) - vocabulaire simple, concepts de base',
                    'seconde': 'Seconde - notions intermediaires, debut de specialisation',
                    'premiere': 'Premiere - notions avancees, preparation au bac',
                    'terminale': 'Terminale - niveau bac, concepts approfondis',
                    'bts': 'BTS/DUT - niveau post-bac, applications professionnelles',
                    'licence': 'Licence/Prepa - niveau universitaire, rigueur scientifique'
                };

                // Recuperer les instructions basees sur les feedbacks precedents
                const feedbackInstructions = getFeedbackInstructions();

                const prompt = `Tu es un assistant pedagogique expert.

SUJET A REVISER : "${sujet}"
NIVEAU SCOLAIRE : ${niveauLabels[niveau]}

Genere une fiche de revision ADAPTEE au sujet ET au niveau demande.

REPONDS UNIQUEMENT en JSON valide. Utilise UNIQUEMENT les sections pertinentes :

{
  "dates": [
    {"date": "1789", "evenement": "Revolution francaise", "detail": "Prise de la Bastille"}
  ],
  "definitions": [
    {"terme": "Terme", "definition": "Explication claire"}
  ],
  "formules": [
    {"nom": "Nom", "formule": "E = mc", "description": "Explication"}
  ],
  "points": [
    {"titre": "Point important", "contenu": "A retenir"}
  ]
}

REGLES STRICTES :
- ADAPTE LA COMPLEXITE AU NIVEAU : vocabulaire, profondeur des explications, difficulte des formules
- "dates" : UNIQUEMENT si le sujet est de l'HISTOIRE ou des EVENEMENTS HISTORIQUES. PAS pour maths, sciences, info, langues.
- "formules" : UNIQUEMENT pour maths, physique, chimie, economie. PAS pour histoire, francais, langues.
- "definitions" : TOUJOURS inclure (adapte au niveau)
- "points" : TOUJOURS inclure (adapte au niveau)
- Si une section n'est pas pertinente au SUJET, NE PAS l'inclure
- Maximum 6 elements par section
- JSON uniquement, sans texte avant ou apres${feedbackInstructions}`;

                const response = await puterAiChatWithRetry(prompt, ficheLoading);

                let text = '';
                if (typeof response === 'string') {
                    text = response;
                } else if (response?.message?.content) {
                    text = response.message.content;
                } else if (response?.text) {
                    text = response.text;
                } else if (response?.content) {
                    text = response.content;
                }

                // Nettoyer le texte pour extraire le JSON
                text = text.trim();
                // Enlever les balises markdown si presentes
                if (text.startsWith('```json')) {
                    text = text.replace(/^```json\n?/, '').replace(/\n?```$/, '');
                } else if (text.startsWith('```')) {
                    text = text.replace(/^```\n?/, '').replace(/\n?```$/, '');
                }

                const data = JSON.parse(text);

                // Afficher les donnees
                displayFicheData(data);
                ficheContent.style.display = 'block';

                // Sauvegarder dans l'historique
                fichesHistory.push({
                    sujet: sujet,
                    data: data,
                    date: new Date().toISOString()
                });
                // Garder seulement les 10 dernieres fiches
                if (fichesHistory.length > 10) {
                    fichesHistory = fichesHistory.slice(-10);
                }
                localStorage.setItem('fiches-history', JSON.stringify(fichesHistory));
                updateHistoriqueDisplay();

            } catch (error) {
                console.error('Erreur:', error);
                ficheError.textContent = `Erreur lors de la generation : ${error.message}`;
                ficheError.style.display = 'block';
            }

            ficheLoading.style.display = 'none';
            btnGenerateFiche.disabled = false;
        });

        // =============================================
        // SYSTEME DE FEEDBACK
        // =============================================
        let currentRating = 0;
        let selectedTags = [];

        // Elements feedback
        const ratingStars = document.querySelectorAll('.star-btn');
        const feedbackTags = document.querySelectorAll('.feedback-tag');
        const feedbackText = document.getElementById('feedback-text');
        const btnSubmitFeedback = document.getElementById('btn-submit-feedback');
        const feedbackSuccess = document.getElementById('feedback-success');
        const ficheFeedback = document.getElementById('fiche-feedback');

        // Gestion des etoiles
        ratingStars.forEach(star => {
            star.addEventListener('click', () => {
                currentRating = parseInt(star.dataset.rating);
                updateStarsDisplay();
            });

            star.addEventListener('mouseenter', () => {
                const rating = parseInt(star.dataset.rating);
                ratingStars.forEach((s, index) => {
                    if (index < rating) {
                        s.innerHTML = '&#9733;'; // Etoile pleine
                        s.style.color = '#FFD700';
                    } else {
                        s.innerHTML = '&#9734;'; // Etoile vide
                        s.style.color = 'var(--text-muted)';
                    }
                });
            });

            star.addEventListener('mouseleave', () => {
                updateStarsDisplay();
            });
        });

        function updateStarsDisplay() {
            ratingStars.forEach((s, index) => {
                if (index < currentRating) {
                    s.innerHTML = '&#9733;';
                    s.style.color = '#FFD700';
                    s.classList.add('active');
                } else {
                    s.innerHTML = '&#9734;';
                    s.style.color = 'var(--text-muted)';
                    s.classList.remove('active');
                }
            });
        }

        // Gestion des tags
        feedbackTags.forEach(tag => {
            tag.addEventListener('click', () => {
                const tagValue = tag.dataset.tag;
                if (selectedTags.includes(tagValue)) {
                    selectedTags = selectedTags.filter(t => t !== tagValue);
                    tag.classList.remove('active');
                } else {
                    selectedTags.push(tagValue);
                    tag.classList.add('active');
                }
            });
        });

        // Reset du feedback pour une nouvelle fiche
        function resetFeedbackForm() {
            currentRating = 0;
            selectedTags = [];
            feedbackText.value = '';
            feedbackSuccess.style.display = 'none';
            btnSubmitFeedback.disabled = false;
            btnSubmitFeedback.textContent = 'Envoyer mon avis';
            updateStarsDisplay();
            feedbackTags.forEach(tag => tag.classList.remove('active'));
        }

        // Soumettre le feedback
        btnSubmitFeedback.addEventListener('click', () => {
            if (currentRating === 0) {
                alert(translations[currentLang]['feedback-rate-alert']);
                return;
            }

            const feedback = {
                sujet: currentFicheSubject,
                niveau: niveauSelect.value,
                rating: currentRating,
                tags: selectedTags,
                comment: feedbackText.value.trim(),
                date: new Date().toISOString()
            };

            feedbackData.push(feedback);
            // Garder les 50 derniers feedbacks
            if (feedbackData.length > 50) {
                feedbackData = feedbackData.slice(-50);
            }
            localStorage.setItem('fiches-feedback', JSON.stringify(feedbackData));

            feedbackSuccess.style.display = 'block';
            btnSubmitFeedback.disabled = true;
            btnSubmitFeedback.textContent = 'Avis envoye !';
        });

        // Modifier la fonction displayFicheData pour reset le feedback
        const originalDisplayFicheData = displayFicheData;
        displayFicheData = function(data) {
            originalDisplayFicheData(data);
            resetFeedbackForm();
        };

        // Charger la langue au demarrage (a la fin pour s'assurer que tous les elements existent)
        loadLang();
    </script>
</body>
</html>
