<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant TDAH Intelligent</title>
    <script src="https://js.puter.com/v2/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Mode sombre (par defaut) */
            --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --bg-secondary: rgba(255, 255, 255, 0.1);
            --bg-tertiary: rgba(255, 255, 255, 0.05);
            --text-primary: #fff;
            --text-secondary: #a0a0a0;
            --text-muted: #888;
            --text-conseil: #ccc;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            /* Mode clair */
            --bg-primary: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            --bg-secondary: rgba(0, 0, 0, 0.05);
            --bg-tertiary: rgba(0, 0, 0, 0.03);
            --text-primary: #1a1a2e;
            --text-secondary: #555;
            --text-muted: #777;
            --text-conseil: #444;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --border-color: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: var(--text-secondary);
        }

        /* Bouton de theme */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow-color);
        }

        .input-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 16px;
            resize: vertical;
            min-height: 100px;
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        .spiciness-section {
            margin: 20px 0;
        }

        .spiciness-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .spiciness-slider {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #4CAF50, #FF9800, #f44336);
            border-radius: 5px;
            outline: none;
        }

        .spiciness-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .spiciness-display {
            text-align: center;
            margin-top: 10px;
            font-size: 1.2em;
        }

        .btn {
            width: 100%;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }

        .task-item:hover {
            background: var(--bg-secondary);
        }

        .task-item.completed {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .task-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #4CAF50;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-category {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 15px 20px;
            border-radius: 10px;
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        /* Pomodoro Timer Styles */
        .pomodoro-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
        }

        .pomodoro-section h2 {
            margin-bottom: 20px;
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .timer-status {
            font-size: 1.2em;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .timer-status.work {
            color: #4CAF50;
        }

        .timer-status.break {
            color: #FF9800;
        }

        .timer-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-timer {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-start {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: #fff;
        }

        .btn-pause {
            background: linear-gradient(135deg, #FF9800 0%, #f57c00 100%);
            color: #fff;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: #fff;
        }

        .btn-timer:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .pomodoro-settings {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .setting-item label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .setting-item input {
            width: 60px;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--text-primary);
            text-align: center;
            font-size: 16px;
        }

        .pomodoro-count {
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .pomodoro-count span {
            color: var(--accent-primary);
            font-weight: bold;
        }

        /* Conseils Section Styles */
        .conseils-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .conseils-section h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .conseil-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s;
        }

        .conseil-card:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .conseil-card h3 {
            color: var(--accent-primary);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .conseil-card p {
            color: var(--text-conseil);
            line-height: 1.6;
        }

        .btn-new-conseil {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn-new-conseil:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .conseils-categories {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }

        .category-btn {
            padding: 8px 16px;
            border: 2px solid var(--accent-primary);
            background: transparent;
            color: var(--accent-primary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .category-btn.active,
        .category-btn:hover {
            background: var(--accent-primary);
            color: #fff;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 25px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: #fff;
        }

        .nav-tab:hover:not(.active) {
            background: var(--input-bg);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Bouton de basculement theme -->
    <button class="theme-toggle" id="theme-toggle" title="Changer de theme">
        <span id="theme-icon">&#9790;</span>
    </button>

    <div class="container">
        <header>
            <h1>Assistant TDAH Intelligent</h1>
            <p>Decompose tes taches, gere ton temps et decouvre des conseils adaptes</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="taches">Taches</button>
            <button class="nav-tab" data-tab="pomodoro">Pomodoro</button>
            <button class="nav-tab" data-tab="conseils">Conseils</button>
        </div>

        <!-- Onglet Taches -->
        <div class="tab-content active" id="tab-taches">
        <div class="input-section">
            <label for="task-input">Decris ta tache :</label>
            <textarea id="task-input" placeholder="Ex: Faire ma dissertation de francais sur le romantisme pour lundi..."></textarea>

            <div class="spiciness-section">
                <div class="spiciness-label">
                    <span>Niveau de detail</span>
                    <span id="spiciness-value">3</span>
                </div>
                <input type="range" min="1" max="5" value="3" class="spiciness-slider" id="spiciness-slider">
                <div class="spiciness-display" id="spiciness-display">Equilibre</div>
            </div>

            <button class="btn btn-primary" id="decompose-btn">Decomposer ma tache</button>
        </div>

        <div class="results-section" id="results-section">
            <div class="loading" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Analyse en cours avec l'IA...</p>
            </div>

            <div id="results-content">
                <div class="results-header">
                    <h2>Ton plan de travail</h2>
                    <span id="task-count"></span>
                </div>

                <ul class="task-list" id="task-list"></ul>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="total-tasks">0</div>
                        <div class="stat-label">Etapes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completed-tasks">0</div>
                        <div class="stat-label">Terminees</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="progress">0%</div>
                        <div class="stat-label">Progression</div>
                    </div>
                </div>
            </div>

            <div class="error" id="error-message" style="display: none;"></div>
        </div>
        </div>

        <!-- Onglet Pomodoro -->
        <div class="tab-content" id="tab-pomodoro">
            <div class="pomodoro-section">
                <h2>Minuteur Pomodoro</h2>
                <div class="timer-status" id="timer-status">Pret a travailler</div>
                <div class="timer-display" id="timer-display">25:00</div>

                <div class="timer-buttons">
                    <button class="btn-timer btn-start" id="btn-start">Demarrer</button>
                    <button class="btn-timer btn-pause" id="btn-pause" style="display: none;">Pause</button>
                    <button class="btn-timer btn-reset" id="btn-reset">Reinitialiser</button>
                </div>

                <div class="pomodoro-settings">
                    <div class="setting-item">
                        <label>Travail (min)</label>
                        <input type="number" id="work-duration" value="25" min="1" max="60">
                    </div>
                    <div class="setting-item">
                        <label>Pause courte (min)</label>
                        <input type="number" id="short-break" value="5" min="1" max="30">
                    </div>
                    <div class="setting-item">
                        <label>Pause longue (min)</label>
                        <input type="number" id="long-break" value="15" min="1" max="60">
                    </div>
                </div>

                <div class="pomodoro-count">
                    Pomodoros completes : <span id="pomodoro-count">0</span>
                </div>
            </div>
        </div>

        <!-- Onglet Conseils -->
        <div class="tab-content" id="tab-conseils">
            <div class="conseils-section">
                <h2>Conseils TDAH</h2>

                <div class="conseils-categories">
                    <button class="category-btn active" data-category="tous">Tous</button>
                    <button class="category-btn" data-category="concentration">Concentration</button>
                    <button class="category-btn" data-category="organisation">Organisation</button>
                    <button class="category-btn" data-category="motivation">Motivation</button>
                    <button class="category-btn" data-category="gestion-stress">Gestion du stress</button>
                </div>

                <div id="conseils-container">
                    <div class="conseil-card" data-category="concentration">
                        <h3>La regle des 2 minutes</h3>
                        <p>Si une tache prend moins de 2 minutes, fais-la immediatement. Cela evite l'accumulation de petites taches qui encombrent ton esprit.</p>
                    </div>
                    <div class="conseil-card" data-category="organisation">
                        <h3>Un seul endroit pour tout noter</h3>
                        <p>Utilise un seul carnet ou une seule application pour toutes tes notes. Evite d'eparpiller tes idees sur plusieurs supports.</p>
                    </div>
                    <div class="conseil-card" data-category="concentration">
                        <h3>Elimine les distractions</h3>
                        <p>Mets ton telephone en mode avion, ferme les onglets inutiles, et previens ton entourage que tu travailles. Chaque interruption te coute 20 minutes de reconcentration.</p>
                    </div>
                    <div class="conseil-card" data-category="motivation">
                        <h3>Recompense-toi</h3>
                        <p>Apres chaque tache accomplie, accorde-toi une petite recompense : une pause, un snack, ou quelques minutes sur ton activite preferee.</p>
                    </div>
                    <div class="conseil-card" data-category="gestion-stress">
                        <h3>La respiration 4-7-8</h3>
                        <p>Inspire pendant 4 secondes, retiens ta respiration 7 secondes, expire pendant 8 secondes. Repete 3 fois pour calmer rapidement ton anxiete.</p>
                    </div>
                    <div class="conseil-card" data-category="organisation">
                        <h3>Prepare la veille</h3>
                        <p>Chaque soir, prepare tes affaires et note les 3 taches prioritaires du lendemain. Tu gagneras du temps et de l'energie mentale le matin.</p>
                    </div>
                    <div class="conseil-card" data-category="motivation">
                        <h3>Commence par le plus difficile</h3>
                        <p>Tackle ta tache la plus redoutee en premier, quand ton energie est au maximum. Le reste de la journee te semblera plus facile.</p>
                    </div>
                    <div class="conseil-card" data-category="concentration">
                        <h3>Le body doubling</h3>
                        <p>Travaille en presence d'une autre personne (meme en visio). La presence d'autrui aide a maintenir la concentration et la motivation.</p>
                    </div>
                    <div class="conseil-card" data-category="gestion-stress">
                        <h3>Accepte l'imperfection</h3>
                        <p>Mieux vaut une tache terminee a 80% qu'une tache parfaite jamais finie. Le perfectionnisme est souvent l'ennemi de la productivite.</p>
                    </div>
                    <div class="conseil-card" data-category="organisation">
                        <h3>Utilise des alarmes</h3>
                        <p>Programme des rappels pour les taches importantes, les rendez-vous, et meme les pauses. Ton cerveau TDAH a besoin de signaux externes.</p>
                    </div>
                </div>

                <button class="btn-new-conseil" id="btn-new-conseil">Obtenir un conseil personnalise (IA)</button>
                <div id="conseil-ia" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // GESTION DU THEME CLAIR/SOMBRE
        // =============================================
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        // Charger le theme sauvegarde ou detecter la preference systeme
        function loadTheme() {
            const savedTheme = localStorage.getItem('tdah-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            } else {
                // Detecter la preference systeme
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = prefersDark ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                updateThemeIcon(theme);
            }
        }

        function updateThemeIcon(theme) {
            if (theme === 'light') {
                themeIcon.innerHTML = '&#9728;'; // Soleil
                themeToggle.title = 'Passer en mode sombre';
            } else {
                themeIcon.innerHTML = '&#9790;'; // Lune
                themeToggle.title = 'Passer en mode clair';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('tdah-theme', newTheme);
            updateThemeIcon(newTheme);
        }

        themeToggle.addEventListener('click', toggleTheme);

        // Charger le theme au demarrage
        loadTheme();

        // Ecouter les changements de preference systeme
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('tdah-theme')) {
                const theme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                updateThemeIcon(theme);
            }
        });

        const SPICINESS_CONFIG = {
            1: { label: "Minimaliste", emoji: "", description: "3-4 grandes etapes" },
            2: { label: "Simplifie", emoji: "", description: "4-6 etapes principales" },
            3: { label: "Equilibre", emoji: "", description: "6-8 etapes detaillees" },
            4: { label: "Detaille", emoji: "", description: "8-10 micro-etapes" },
            5: { label: "Ultra-detaille", emoji: "", description: "10-12 mini-etapes" }
        };

        const spicinessSlider = document.getElementById('spiciness-slider');
        const spicinessValue = document.getElementById('spiciness-value');
        const spicinessDisplay = document.getElementById('spiciness-display');
        const taskInput = document.getElementById('task-input');
        const decomposeBtn = document.getElementById('decompose-btn');
        const resultsSection = document.getElementById('results-section');
        const loading = document.getElementById('loading');
        const resultsContent = document.getElementById('results-content');
        const taskList = document.getElementById('task-list');
        const errorMessage = document.getElementById('error-message');

        let tasks = [];

        spicinessSlider.addEventListener('input', () => {
            const value = spicinessSlider.value;
            spicinessValue.textContent = value;
            const config = SPICINESS_CONFIG[value];
            spicinessDisplay.textContent = `${config.emoji} ${config.label} - ${config.description}`;
        });

        decomposeBtn.addEventListener('click', async () => {
            const task = taskInput.value.trim();
            if (!task) {
                alert('Decris ta tache avant de la decomposer !');
                return;
            }

            resultsSection.classList.add('visible');
            loading.style.display = 'block';
            resultsContent.style.display = 'none';
            errorMessage.style.display = 'none';
            decomposeBtn.disabled = true;

            try {
                const spiciness = parseInt(spicinessSlider.value);
                const config = SPICINESS_CONFIG[spiciness];

                const prompt = `Tu es un expert en decomposition de taches pour personnes TDAH.

NIVEAU DE DETAIL : ${config.label} (${config.description})

TACHE A DECOMPOSER :
"${task}"

REGLES ABSOLUES :
1. Entre ${spiciness + 2} et ${spiciness + 7} etapes maximum
2. UN verbe d'action au debut de chaque etape
3. Phrases courtes (10 mots max)
4. Ordre logique progressif
5. Adapte au niveau scolaire francais

REPONDS UNIQUEMENT avec la liste numerotee, rien d'autre :
1. [ACTION]
2. [ACTION]
...`;

                console.log('Envoi du prompt a Puter...');

                // Verifier que puter est disponible
                if (typeof puter === 'undefined') {
                    throw new Error('Puter.js non charge. Verifie ta connexion internet.');
                }

                const response = await puter.ai.chat(prompt);
                console.log('Reponse brute:', response);
                console.log('Type de reponse:', typeof response);
                console.log('Cles de response:', response ? Object.keys(response) : 'null');

                // Puter.js v2 retourne un objet avec message.content
                let text = '';
                if (typeof response === 'string') {
                    text = response;
                } else if (response?.message?.content) {
                    text = response.message.content;
                } else if (response?.text) {
                    text = response.text;
                } else if (response?.content) {
                    text = response.content;
                } else if (response?.choices?.[0]?.message?.content) {
                    text = response.choices[0].message.content;
                } else {
                    // Dernier recours: chercher n'importe quelle string dans l'objet
                    const str = JSON.stringify(response);
                    console.log('Response stringify:', str);
                    text = str;
                }

                console.log('Texte extrait:', text);

                if (!text || text === '{}' || text === 'undefined' || text === 'null') {
                    throw new Error('Reponse vide. Assure-toi d\'etre connecte a Puter (popup de connexion).');
                }

                tasks = parseResponse(text);
                console.log('Taches parsees:', tasks);

                if (tasks.length === 0) {
                    // Essayer de parser meme sans numeros
                    const lines = text.split('\n').filter(l => l.trim().length > 5);
                    if (lines.length > 0) {
                        tasks = lines.slice(0, 10).map((line, i) => ({
                            id: i + 1,
                            title: line.replace(/^[\d\.\-\*]+\s*/, '').trim(),
                            completed: false
                        }));
                    }
                }

                if (tasks.length === 0) {
                    throw new Error('Parsing echoue. Reponse brute: ' + text.substring(0, 300));
                }

                displayTasks(tasks);

                loading.style.display = 'none';
                resultsContent.style.display = 'block';

            } catch (error) {
                console.error('Erreur:', error);
                loading.style.display = 'none';
                errorMessage.textContent = `Erreur: ${error.message}`;
                errorMessage.style.display = 'block';
            }

            decomposeBtn.disabled = false;
        });

        function parseResponse(text) {
            const lines = text.split('\n')
                .map(line => line.trim())
                .filter(line => /^\d+\./.test(line))
                .map(line => line.replace(/^\d+\.\s*/, ''));

            return lines.map((title, index) => ({
                id: index + 1,
                title: title,
                completed: false
            }));
        }

        function displayTasks(tasks) {
            taskList.innerHTML = '';

            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'task-item' + (task.completed ? ' completed' : '');
                li.innerHTML = `
                    <div class="task-number">${index + 1}</div>
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} data-index="${index}">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                    </div>
                `;
                taskList.appendChild(li);
            });

            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    tasks[index].completed = e.target.checked;
                    e.target.closest('.task-item').classList.toggle('completed', e.target.checked);
                    updateStats();
                });
            });

            updateStats();
        }

        function updateStats() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('total-tasks').textContent = total;
            document.getElementById('completed-tasks').textContent = completed;
            document.getElementById('progress').textContent = progress + '%';
            document.getElementById('task-count').textContent = `${completed}/${total} terminees`;
        }

        // Initialiser l'affichage du spiciness
        spicinessSlider.dispatchEvent(new Event('input'));

        // =============================================
        // NAVIGATION PAR ONGLETS
        // =============================================
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `tab-${targetTab}`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // =============================================
        // MINUTEUR POMODORO
        // =============================================
        let pomodoroInterval = null;
        let pomodoroTimeLeft = 25 * 60;
        let pomodoroIsRunning = false;
        let pomodoroMode = 'work'; // 'work', 'shortBreak', 'longBreak'
        let pomodoroCount = 0;

        const timerDisplay = document.getElementById('timer-display');
        const timerStatus = document.getElementById('timer-status');
        const btnStart = document.getElementById('btn-start');
        const btnPause = document.getElementById('btn-pause');
        const btnReset = document.getElementById('btn-reset');
        const workDurationInput = document.getElementById('work-duration');
        const shortBreakInput = document.getElementById('short-break');
        const longBreakInput = document.getElementById('long-break');
        const pomodoroCountDisplay = document.getElementById('pomodoro-count');

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(pomodoroTimeLeft);
        }

        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Son non disponible');
            }
        }

        function startPomodoro() {
            pomodoroIsRunning = true;
            btnStart.style.display = 'none';
            btnPause.style.display = 'inline-block';

            pomodoroInterval = setInterval(() => {
                pomodoroTimeLeft--;
                updateTimerDisplay();

                if (pomodoroTimeLeft <= 0) {
                    clearInterval(pomodoroInterval);
                    playNotificationSound();

                    if (pomodoroMode === 'work') {
                        pomodoroCount++;
                        pomodoroCountDisplay.textContent = pomodoroCount;

                        if (pomodoroCount % 4 === 0) {
                            pomodoroMode = 'longBreak';
                            pomodoroTimeLeft = parseInt(longBreakInput.value) * 60;
                            timerStatus.textContent = 'Pause longue - Tu l\'as bien merite !';
                            timerStatus.className = 'timer-status break';
                        } else {
                            pomodoroMode = 'shortBreak';
                            pomodoroTimeLeft = parseInt(shortBreakInput.value) * 60;
                            timerStatus.textContent = 'Pause courte - Detends-toi !';
                            timerStatus.className = 'timer-status break';
                        }
                    } else {
                        pomodoroMode = 'work';
                        pomodoroTimeLeft = parseInt(workDurationInput.value) * 60;
                        timerStatus.textContent = 'Temps de travail - Concentre-toi !';
                        timerStatus.className = 'timer-status work';
                    }

                    updateTimerDisplay();
                    pomodoroIsRunning = false;
                    btnStart.style.display = 'inline-block';
                    btnPause.style.display = 'none';

                    if (Notification.permission === 'granted') {
                        new Notification('Pomodoro', {
                            body: pomodoroMode === 'work' ? 'C\'est l\'heure de travailler !' : 'Pause terminee, c\'est reparti !',
                            icon: 'ðŸ…'
                        });
                    }
                }
            }, 1000);
        }

        function pausePomodoro() {
            pomodoroIsRunning = false;
            clearInterval(pomodoroInterval);
            btnStart.style.display = 'inline-block';
            btnPause.style.display = 'none';
            timerStatus.textContent = 'En pause';
        }

        function resetPomodoro() {
            clearInterval(pomodoroInterval);
            pomodoroIsRunning = false;
            pomodoroMode = 'work';
            pomodoroTimeLeft = parseInt(workDurationInput.value) * 60;
            updateTimerDisplay();
            btnStart.style.display = 'inline-block';
            btnPause.style.display = 'none';
            timerStatus.textContent = 'Pret a travailler';
            timerStatus.className = 'timer-status';
        }

        btnStart.addEventListener('click', startPomodoro);
        btnPause.addEventListener('click', pausePomodoro);
        btnReset.addEventListener('click', resetPomodoro);

        workDurationInput.addEventListener('change', () => {
            if (!pomodoroIsRunning && pomodoroMode === 'work') {
                pomodoroTimeLeft = parseInt(workDurationInput.value) * 60;
                updateTimerDisplay();
            }
        });

        // Demander la permission pour les notifications
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // =============================================
        // SECTION CONSEILS
        // =============================================
        const categoryButtons = document.querySelectorAll('.category-btn');
        const conseilCards = document.querySelectorAll('.conseil-card');
        const btnNewConseil = document.getElementById('btn-new-conseil');
        const conseilIaContainer = document.getElementById('conseil-ia');

        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.dataset.category;

                categoryButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                conseilCards.forEach(card => {
                    if (category === 'tous' || card.dataset.category === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

        btnNewConseil.addEventListener('click', async () => {
            btnNewConseil.disabled = true;
            btnNewConseil.textContent = 'Generation en cours...';

            conseilIaContainer.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>L'IA reflechit a un conseil pour toi...</p>
                </div>
            `;

            try {
                const prompt = `Tu es un coach specialise dans l'accompagnement des personnes TDAH.

Donne UN SEUL conseil pratique et actionnable pour aider quelqu'un avec un TDAH a mieux gerer son quotidien.

REGLES :
- Le conseil doit etre NOUVEAU et ORIGINAL
- Maximum 3 phrases
- Langage simple et bienveillant
- Tutoiement
- Inclus une technique concrete

REPONDS avec ce format exact :
TITRE: [titre court du conseil]
CONSEIL: [ton conseil]`;

                const response = await puter.ai.chat(prompt);

                let text = '';
                if (typeof response === 'string') {
                    text = response;
                } else if (response && response.message && response.message.content) {
                    text = response.message.content;
                } else if (response && typeof response.toString === 'function') {
                    text = response.toString();
                }

                const titleMatch = text.match(/TITRE:\s*(.+)/i);
                const conseilMatch = text.match(/CONSEIL:\s*(.+)/is);

                const title = titleMatch ? titleMatch[1].trim() : 'Conseil du jour';
                const conseil = conseilMatch ? conseilMatch[1].trim() : text;

                conseilIaContainer.innerHTML = `
                    <div class="conseil-card" style="border-left-color: #4CAF50;">
                        <h3>âœ¨ ${title}</h3>
                        <p>${conseil}</p>
                    </div>
                `;

            } catch (error) {
                conseilIaContainer.innerHTML = `
                    <div class="error">
                        Erreur lors de la generation du conseil : ${error.message}
                    </div>
                `;
            }

            btnNewConseil.disabled = false;
            btnNewConseil.textContent = 'Obtenir un conseil personnalise (IA)';
        });
    </script>
</body>
</html>
